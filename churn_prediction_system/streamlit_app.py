# -*- coding: utf-8 -*-
"""streamlit_app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1PGQwd1A7KdwwbdH7lJNVuwEk7i--2MFs
"""

import streamlit as st
import requests
import pandas as pd
import numpy as np
import joblib

import shap
import matplotlib.pyplot as plt

# FastAPI endpoint
API_URL = "http://127.0.0.1:8000/predict"

st.set_page_config(page_title="Churn Prediction", layout="centered")

st.title("üìâ Customer Churn Prediction")

# -------------------------
# Personal Information
# -------------------------
st.header("Personal Information")

customer_age = st.number_input("Customer Age", min_value=18, max_value=100, value=30)
gender = st.selectbox("Gender", ["M", "F"])
dependent_count = st.number_input("Dependent Count", min_value=0, max_value=10, value=0)

# -------------------------
# Education & Demographics
# -------------------------
st.header("Education & Demographics")

education_level = st.selectbox(
    "Education Level",
    [
        "Unknown", "Uneducated", "High School", "College",
        "Graduate", "Post-Graduate", "Doctorate"
    ]
)

marital_status = st.selectbox(
    "Marital Status",
    ["Married", "Single", "Divorced", "Unknown"]
)

income_category = st.selectbox(
    "Income Category",
    [
        "Unknown", "Less than $40K", "$40K - $60K",
        "$60K - $80K", "$80K - $120K", "$120K +"
    ]
)

card_category = st.selectbox(
    "Card Category",
    ["Blue", "Silver", "Gold", "Platinum"]
)

# -------------------------
# Account Details
# -------------------------
st.header("Account Details")

months_on_book = st.number_input("Months on Book", min_value=0, value=12)
total_relationship_count = st.number_input("Total Relationship Count", min_value=0, value=1)
months_inactive_12_mon = st.number_input("Months Inactive (Last 12 Months)", min_value=0, value=0)
contacts_count_12_mon = st.number_input("Contacts Count (Last 12 Months)", min_value=0, value=0)

# -------------------------
# Financial Metrics
# -------------------------
st.header("Financial Metrics")

credit_limit = st.number_input("Credit Limit", min_value=0.0, value=5000.0)
total_revolving_bal = st.number_input("Total Revolving Balance", min_value=0.0, value=1000.0)
avg_open_to_buy = st.number_input("Average Open to Buy", min_value=0.0, value=4000.0)
total_amt_chng_q4_q1 = st.number_input("Total Amount Change Q4/Q1", min_value=0.0, value=1.0)

# -------------------------
# Transaction Behavior
# -------------------------
st.header("Transaction Behavior")

total_trans_amt = st.number_input("Total Transaction Amount", min_value=0.0, value=1000.0)
total_trans_ct = st.number_input("Total Transaction Count", min_value=0, value=50)
total_ct_chng_q4_q1 = st.number_input("Total Count Change Q4/Q1", min_value=0.0, value=1.0)
avg_utilization_ratio = st.number_input(
    "Average Utilization Ratio", min_value=0.0, max_value=1.0, value=0.5
)

# -------------------------
# Predict Button
# -------------------------
if st.button("üîÆ Predict Churn"):
    payload = {
        "customer_age": customer_age,
        "gender": gender,
        "dependent_count": dependent_count,
        "education_level": education_level,
        "marital_status": marital_status,
        "income_category": income_category,
        "card_category": card_category,
        "months_on_book": months_on_book,
        "total_relationship_count": total_relationship_count,
        "months_inactive_12_mon": months_inactive_12_mon,
        "contacts_count_12_mon": contacts_count_12_mon,
        "credit_limit": credit_limit,
        "total_revolving_bal": total_revolving_bal,
        "avg_open_to_buy": avg_open_to_buy,
        "total_amt_chng_q4_q1": total_amt_chng_q4_q1,
        "total_trans_amt": total_trans_amt,
        "total_trans_ct": total_trans_ct,
        "total_ct_chng_q4_q1": total_ct_chng_q4_q1,
        "avg_utilization_ratio": avg_utilization_ratio
    }

    try:
        response = requests.post(API_URL, json=payload)
        response.raise_for_status()

        result = response.json()

        st.success("Prediction successful üéØ")

        st.metric(
            label="Attrition Probability",
            value=f"{result['attrition_probability'] * 100:.2f}%"
        )

        churn_label = "YES ‚ùå" if result["attrition_prediction"] == 1 else "NO ‚úÖ"
        st.subheader(f"Churn Prediction: {churn_label}")

    except requests.exceptions.RequestException as e:
        st.error(f"API Error: {e}")